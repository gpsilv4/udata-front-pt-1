import requests
import os
import sys
import urllib3
import json
from dotenv import load_dotenv

# Adiciona o diret√≥rio raiz ao path para poder importar udata_front
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "../..")))

try:
    from udata_front.security import sanitize_svg
except ImportError:
    print("ERRO: N√£o foi poss√≠vel importar udata_front.security.")
    sys.exit(1)

# Suppress InsecureRequestWarning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

load_dotenv()

BASE_URL = os.getenv("UDATA_BASE_URL", "http://dev.local:7000/api/1/")
DATASET_ID = os.getenv("EXPORT_CSV_DATASET_ID", "67c5a3b3b50fe67ba7aa1905")
API_KEY = os.getenv(
    "UDATA_API_KEY",
    "eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjoiNjcxNjZiNzk4NjA4MjBhMzc1YzUwMDhiIiwidGltZSI6MTc1MTM2ODYzMi45MDc3MzI1fQ.9mty0o-vtRwH5jOyWcosukMF4qiyHOKSYCBHSNryD1ASpDU98NvXccBnxNhf98ovIqeObl6t1A-TyLzWsZwf9w",
)

# Configura√ß√£o dos Endpoints
ENDPOINTS = [
    {
        "name": "Resources Endpoint",
        "url": f"{BASE_URL}datasets/{DATASET_ID}/resources/",
    },
    {
        "name": "Community Upload Endpoint",
        "url": f"{BASE_URL}datasets/{DATASET_ID}/resources/upload/community/",
    },
]

# Configura√ß√£o dos Payloads
PAYLOADS = [
    {
        "type": "SVG (XSS)",
        "file": "malicious_xss.svg",
        "mime": "image/svg+xml",
        "content": """<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert('XSS Exploit');</script>
  <circle cx="50" cy="50" r="40" fill="blue" />
</svg>""",
    },
    {
        "type": "XML (XXE)",
        "file": "malicious_xxe.xml",
        "mime": "application/xml",
        "content": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg xmlns="http://www.w3.org/2000/svg">
  <text>&xxe;</text>
</svg>""",
    },
    {
        "type": "XML Disguised SVG (XSS)",
        "file": "disguised_xss.xml",
        "mime": "application/xml",
        "content": """<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert('XSS via XML extension');</script>
  <rect width="100" height="100" fill="green" />
</svg>""",
    },
]


def run_test(payload, endpoint):
    print(f"\n[ TESTE ] Payload: {payload['type']} -> Endpoint: {endpoint['name']}")
    print(f"URL: {endpoint['url']} | Ficheiro: {payload['file']}")

    content_bytes = payload["content"].encode("utf-8")

    # --- VERIFICA√á√ÉO DE SEGURAN√áA (udata_front/security.py) ---
    security_passed = True
    print(">> Verifica√ß√£o de Seguran√ßa Local (sanitize_svg)...")
    try:
        sanitized = sanitize_svg(content_bytes)
        if sanitized != content_bytes:
            print(">> ‚ö†Ô∏è  SEGURAN√áA: Conte√∫do malicioso detectado e removido!")
            security_passed = False
        else:
            print(">> ‚úÖ SEGURAN√áA: Nenhuma amea√ßa detectada localmente.")
    except Exception as e:
        print(f">> ‚ùå SEGURAN√áA: Ficheiro rejeitado! Erro: {e}")
        security_passed = False

    # Mensagem de conformidade com o pedido: "n√£o permitir que fa√ßa o ficheiro caso seja malicioso"
    if not security_passed:
        print(
            f">> üö´ BLOQUEIO: O envio de '{payload['file']}' foi bloqueado devido ao conte√∫do malicioso."
        )
        return

    # --- TENTATIVA DE UPLOAD ---
    print(">> A tentar realizar o upload...")
    files = {"file": (payload["file"], content_bytes, payload["mime"])}
    headers = {"X-API-KEY": API_KEY}
    data = {"title": f"Teste {payload['type']}", "filename": payload["file"]}

    try:
        response = requests.post(
            endpoint["url"], files=files, data=data, headers=headers, verify=False
        )
        print(f">> Status: {response.status_code}")
        print(f">> Resposta: {response.text[:150]}...")
    except Exception as e:
        print(f">> ERRO Connection: {e}")


if __name__ == "__main__":
    for payload in PAYLOADS:
        for endpoint in ENDPOINTS:
            run_test(payload, endpoint)

    print("\n[ FIM ] Todos os testes conclu√≠dos.")
