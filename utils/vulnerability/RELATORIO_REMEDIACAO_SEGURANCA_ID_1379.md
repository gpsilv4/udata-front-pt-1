# Relatório de Remediação de Segurança: Vulnerabilidade ID 1379

## 1. Resumo Executivo

Este relatório detalha as medidas implementadas para mitigar as vulnerabilidades identificadas no relatório **KITS24 ID 1379**, relacionadas com o upload de ficheiros vetoriais (SVG e XML). A solução foca-se na implementação de uma camada de sanitização robusta e proativa que intercepta uploads maliciosos antes de serem persistidos no sistema.

## 2. Diagnóstico da Vulnerabilidade (ID 1379)

O relatório original identificou três vetores de ataque principais:

- **Stored Cross-Site Scripting (XSS)**: Execução de scripts maliciosos injetados em ficheiros SVG quando visualizados por utilizadores.
- **XML External Entity (XXE) Injection**: Exploração do parser XML para ler ficheiros internos do servidor ou realizar SSRF.
- **Filter Bypass**: Utilização de extensões alternativas (ex: alterar `.svg` para `.xml`) para contornar restrições básicas de tipo de ficheiro.

## 3. Estratégia de Remediação Implementada

### 3.1 Camada de Segurança (`udata_front/security.py`)

Implementámos a função `sanitize_svg` que atua como o motor de limpeza principal:

- **Safe XML Parsing**: Utilização da biblioteca `defusedxml` para desativar a resolução de entidades externas e DTDs, neutralizando ataques XXE.
- **Blacklist de Tags**: Remoção agressiva de tags perigosas como `<script>`, `<iframe>`, `<object>`, `<embed>`, entre outras.
- **Filtragem de Atributos**: Detecção e remoção de atributos de evento (ex: `onload`, `onclick`) via Regex.
- **Validação de URIs**: Bloqueio de esquemas perigosos como `javascript:`, `vbscript:` e `data:` dentro de atributos `href` ou `src`.
- **Enforcement de Limites de Tamanho**: Implementação de restrições rigorosas diferenciadas para prevenir ataques de negação de serviço (DoS):
  - **SVG**: Limite de **5MB** (`MAX_SVG_SIZE`), adequado para imagens vetoriais.
  - **XML**: Limite de **50MB** (`MAX_XML_SIZE`) para ficheiros de dados estruturados genéricos.
    Qualquer ficheiro que exceda estes limites é rejeitado imediatamente antes do processamento.

### 3.2 Intercepção Operacional (`udata_front/__init__.py`)

Através de um **Monkeypatch** no `UploadMixin` do udata, garantimos que a segurança é aplicada em todos os fluxos de upload:

- **Deep Inspection**: O sistema agora analisa não apenas ficheiros `.svg`, mas também ficheiros `.xml` e mimetypes associados.
- **Proteção Contra Bypass**: Mesmo que um utilizador mude a extensão de um ficheiro malicioso para `.xml` (que é permitido nativamente no `udata.cfg`), a nossa camada de segurança intercepta-o e sanitiza-o.

## 4. Análise de Configurações Nativa vs Personalizada

### 4.1 Configuração NGINX/Udata (`udata.cfg`)

Atualmente, o ficheiro `udata.cfg` **não lista 'svg'** na variável `ALLOWED_RESOURCES_EXTENSIONS` (Linha 218).

- **Padrão udata**: Por segurança, o udata bloqueia SVGs nativamente devido ao risco inerente de XSS.
- **Abordagem dados.gov.pt**: Em vez de simplesmente permitir a extensão no `udata.cfg` (o que seria inseguro), optámos por manter a restrição nativa e utilizar o Monkeypatch em `__init__.py` para realizar um bypass controlado. Isto permite o upload apenas se o ficheiro passar na nossa auditoria de sanitização rigorosa.

## 5. Validação de Resultados (Testes de Intrusão)

Criámos um script de teste dedicado (`utils/vulnerability/teste_upload_svg.py`) que validou com sucesso os seguintes cenários:

1.  **Ataque XSS via SVG**: O script detetou a presença de `<script>` e bloqueou o envio.
2.  **Ataque XXE via XML**: O parser seguro emitiu um erro `EntitiesForbidden`, impedindo a leitura de ficheiros do servidor.
3.  **Ataque Bypass (SVG como XML)**: O sistema detetou código malicioso escondido num ficheiro com extensão `.xml` e aplicou a mesma regra de bloqueio.
4.  **Limite de Tamanho**: Validámos o bloqueio de ficheiros SVG superiores a 5MB, garantindo a proteção contra ataques de exaustão de recursos.

## 6. Conclusão e Melhores Práticas

A implementação atual está **alinhada com as melhores práticas de mitigação (ASVS/OWASP)**:

- **Princípio de Falha Segura (Fail-Closed)**: Qualquer erro no processo de sanitização resulta na rejeição imediata do ficheiro.
- **Defesa em Profundidade**: A segurança é aplicada tanto no nível de parsing XML como no nível de sanitização de tags HTML/SVG.
- **Monitorização**: Todos os incidentes de segurança (tentativas de upload malicioso) são registados (`log.error`).

---

_Relatório gerado em: 2026-02-20_
_Responsável: Antigravity AI Security Assistant_
